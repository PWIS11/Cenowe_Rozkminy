---
title: "Analiza cen mieszkań w Polsce"
date: "`r Sys.Date()`"
author: "Piotr Wiśniewski - lider zespołu, Izabela Reszka, Klaudia Woźniak"
output:
  html_document:
    theme: cerulean
    highlight: tango
    highlight_color: "goldenrod"
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
# Instalacja Pakietów
if (!requireNamespace("httr", quietly = TRUE)) install.packages("httr")
if (!requireNamespace("jsonlite", quietly = TRUE)) install.packages("jsonlite")
if (!requireNamespace("tidygeocoder", quietly = TRUE)) install.packages("tidygeocoder")
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
if (!requireNamespace("sf", quietly = TRUE)) install.packages("sf")
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
if (!requireNamespace("scales", quietly = TRUE)) install.packages("scales")
if (!requireNamespace("tidyverse", quietly = TRUE)) install.packages("tidyverse")
if (!requireNamespace("naniar", quietly = TRUE)) install.packages("naniar")
if (!requireNamespace("VIM", quietly = TRUE)) install.packages("VIM")
if (!requireNamespace("outliers", quietly = TRUE)) install.packages("outliers")
if (!requireNamespace("caret", quietly = TRUE)) install.packages("caret")
if (!requireNamespace("mice", quietly = TRUE)) install.packages("mice")
if (!requireNamespace("gridExtra", quietly = TRUE)) install.packages("gridExtra")
if (!requireNamespace("dlookr", quietly = TRUE)) install.packages("dlookr")

```

```{r libraries, include=FALSE}
library(httr)
library(jsonlite)
library(tidygeocoder)
library(dplyr)
library(sf)
library(ggplot2)
library(scales)
library(tidyverse)
library(naniar)
library(VIM)
library(outliers)
library(caret)
library(mice)
library(gridExtra)
library(dlookr)
```

# **Cel projektu**

Celem naszego projektu jest analiza cen mieszkań w największych miastach Polski, uwzględniając różnorodne czynniki, które mogą wpływać na wartość nieruchomości. Wykorzystamy metody analizy danych, aby odpowiedzieć na kluczowe pytania, takie jak:

-   *Od czego zależy cena mieszkań?*

-   *Jakie różnice w cenach występują pomiędzy miastami?*

-   *Czy odległość od centrum lub interesujących miejsc (POI) ma znaczenie dla wartości nieruchomości?*

-   *Które cechy mieszkań (np. liczba pokoi, stan, udogodnienia) są najbardziej cenione?*

### **Analizy w projekcie**

Planujemy zastosowanie narzędzi analizy danych oraz wizualizacji, aby lepiej zrozumieć rynek nieruchomości w Polsce. Nasze analizy obejmą:

-   Badanie zależności między cechami mieszkań (takimi jak lokalizacja, powierzchnia, liczba pokoi) a ich ceną.

-   Porównanie cen nieruchomości pomiędzy największymi polskimi miastami, w celu wykazania kluczowych różnic regionalnych.

-   Modelowanie predykcyjne, które pozwoli oszacować cenę mieszkań na podstawie wybranych zmiennych, takich jak odległość od centrum czy stan mieszkania.

-   Wykorzystanie interaktywnych wizualizacji, takich jak mapy i wykresy, aby przedstawić wyniki w przystępny sposób.

### **Hipotezy i oczekiwane wyniki**

1.  **Odległość od centrum miasta:** Zakładamy, że im bliżej centrum, tym wyższa cena mieszkań, choć siła tego wpływu może różnić się w zależności od miasta.

2.  **Cechy nieruchomości:** Udogodnienia takie jak balkon, winda czy miejsce parkingowe znacząco podnoszą wartość mieszkań, zwłaszcza w dużych miastach.

3.  **Różnice regionalne:** Miasta o wyższym poziomie urbanizacji i rozwiniętej infrastrukturze (np. Warszawa, Kraków, Wrocław) mają wyższe ceny mieszkań w porównaniu do mniejszych miejscowości.

4.  **Rok budowy:** Starsze mieszkania, wymagające remontu, są z reguły tańsze, chyba że znajdują się w prestiżowych lokalizacjach.

Podsumowując, oczekujemy, że nasze analizy wskażą najważniejsze czynniki wpływające na ceny mieszkań oraz umożliwią stworzenie użytecznych modeli predykcyjnych, które mogą wspierać decyzje zakupowe lub inwestycyjne.

5.  Czy wiek mieszkania ma taki sam wpływ na jego cenę w centrum jak na obrzeżach?

# **Opis danych**

Zbiór danych pochodzi z ofert sprzedaży i wynajmu mieszkań z 15 największych polskich miast, zgromadzonych w czerwcu 2024 roku. Dane te obejmują szerokie spektrum cech nieruchomości oraz dodatkowe informacje z Open Street Map, które pozwalają uwzględnić kontekst sąsiedztwa mieszkań.

**Miasta w zbiorze danych:** Warszawa, Łódź, Kraków, Wrocław, Poznań, Gdańsk, Szczecin, Bydgoszcz, Lublin, Katowice, Białystok, Częstochowa.

**Główne pola w zbiorze danych:**

-   ***Lokalizacja i charakterystyka nieruchomości:***

    -   Miasto, typ budynku, wielkość w metrach kwadratowych, liczba pokoi, piętro, rok budowy.

-   ***Informacje kontekstowe:***

    -   Odległość od centrum miasta, liczba interesujących punktów w promieniu 500 metrów (np. szkoły, apteki, restauracje) oraz odległość do najbliższego punktu.

-   ***Cechy nieruchomości:***

    -   Stan mieszkania, rodzaj własności, obecność udogodnień (np. winda, balkon, miejsce parkingowe, ochrona).

-   ***Cena ofertowa:***

    -   Cena sprzedaży lub miesięczny czynsz.

# **Dane dodatkowe**

### **Znaczenie projektu**

Rynek nieruchomości jest dynamiczny i podlega wpływowi wielu czynników, takich jak lokalizacja, liczba pokoi, dostępność udogodnień czy bliskość kluczowych miejsc. Analiza tych danych pozwoli lepiej zrozumieć mechanizmy kształtowania się cen mieszkań oraz stworzyć narzędzia wspomagające decyzje zakupowe i inwestycyjne.

# **Data wrangling**

### **Obserwacje brakujące**

```{r wstepna_obrobka_danych}
# Przygotowanie i wczytanie danych 
dane <- read.csv("apartments_pl_2024_06.csv", sep = ",", header = TRUE)

# Zmiana id na liczby rosnące, zaczynające się od cyfry 1
dane$id <- 1:nrow(dane)

# Zamiana pustych ciągów na NA
dane[dane == ""] <- NA
```


```{r obserwacje_brakujace_wykresy, echo=FALSE}
missing_summary <- miss_var_summary(dane)

ggplot(missing_summary, aes(x = reorder(variable, -pct_miss), y = pct_miss)) +
  geom_bar(stat = "identity", fill = "plum2") +
  coord_flip() +
  labs(title = "Procent brakujących wartości w kolumnach",
       x = "Kolumny",
       y = "Procent braków (%)") +
  theme_minimal()
```


```{r obserwacje_brakujace_wykresy_2, echo=FALSE}
vismiss <- vis_miss(dane) +
  labs(
    title = "Braki danych w zbiorze",
    x = "Zmienne",
    y = "Obserwacje"
  ) +
  theme_minimal(base_size = 10) + 
  scale_fill_manual(values = c("lightyellow", "orchid3"),
                    name = "Status danych",
                    labels = c("Dane obecne", "Braki danych")) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.2)
  )
print(vismiss)
```


```{r obserwacje_brakujace_wykresy, echo=FALSE}
```

Analiza brakujących danych wskazuje, że kolumny w zbiorze można podzielić na kilka grup pod względem liczby braków:

-   **Bardzo duża liczba braków:** condition (74.0%) i buildingMaterial (40.9%). Ze względu na ich wysoką niekompletność zdecydowaliśmy się usunąć kolumnę condition, a dla buildingMaterial zastosujemy imputację najczęstszą wartością.

-   **Umiarkowana liczba braków:** type (20.5%), floor (16.6%), buildYear (15.7%). Uzupełnimy brakujące wartości odpowiednio metodą najczęstszej wartości dla zmiennych kategorycznych (type) oraz medianą dla zmiennych liczbowych (floor, buildYear).

-   **Niewielka liczba braków:** Kolumny takie jak hasElevator (4.46%) czy collegeDistance (2.72%) zostaną uzupełnione medianą.

-   **Bardzo mała liczba braków:** Pozostałe kolumny z mniej niż 1% braków zostaną imputowane prostymi metodami (medianą lub najczęstszą wartością).

-   **Kolumny bez braków:** Pozostałe zmienne, takie jak price, squareMeters czy rooms, są kompletne i nie wymagają dodatkowych działań.

```{r wzorce_brakow}
aggr(dane, col = c("green", "tomato"), numbers = TRUE, sortVars = TRUE,
     labels = names(data), cex.axis = 0.7, gap = 3, ylab = c("Procent braków", "Wzorce braków"))

# Pozbycie się kolumny "condition", gdzie procent "NA" wynosi ok. 74%
#dane$condition <- NA 
#dane <- subset(dane, select = -condition)

```

# Zastąpenie danych NA; Imputacja medianą oraz najczęstszą wartością

```{r Zastąpienie_braków_medianą_i_najczęstszą_wartością}
# floor
dane$floor<-imputate_na(dane, floor, method = "median")
#median(dane$floor)

# buildYear
dane$buildYear<-imputate_na(dane, buildYear, method = "median")
#median(dane$buildYear)

# hasElevator 
dane$hasElevator<-imputate_na(dane, hasElevator, method = "median")
#median(dane$hasElevator)

# collegeDistance 
dane$collegeDistance<-imputate_na(dane, collegeDistance, method = "median")
#median(dane$collegeDistance)

# Imputacja brakujących danych na najczęstszą wartość w:

#table(na.omit(dane$type))
#table(na.omit(dane$buildingMaterial))

dane$type[is.na(dane$type)] <- "blockOfFlats"
dane$buildingMaterial[is.na(dane$buildingMaterial)] <- "brick"

dane$type <- factor(dane$type)
dane$buildingMaterial <- factor(dane$buildingMaterial)

# buildingMaterial
#dane$buildingMaterial<-imputate_na(dane, buildingMaterial, method = "mode") -----> wyskakuje błąd
# type
#dane$type <- imputate_na(dane, xvar = type, method = "mode")

# Pozbycie się kolumny "condition", gdzie procent "NA" wynosi ok. 74%
dane$condition <- NA
dane <- subset(dane, select = -condition)

```


Klasyfikacja braków danych w zbiorze:

-   **MCAR (Missing Completely At Random)**: Braki w kolumnach takich jak hasElevator i collegeDistance są losowe i wynikają z technicznych pominięć w zbieraniu danych.

-   **MAR (Missing At Random)**: Braki w kolumnach condition, buildingMaterial, oraz floor wynikają z powiązań między zmiennymi, np. type i floorCount.

-   **MNAR (Missing Not At Random)**: Braki w type mogą wynikać z mechanizmu niechęci podawania wartości (np. dla mieszkań luksusowych).


```{r dodatkowe_kolumny1}
# Dodanie kolumny z ceną za metr kwadratowy
dane$pricePerSquareMeter <- dane$price / dane$squareMeters

# Dodanie kolumny z wiekiem mieszkania
currentYear <- format(Sys.Date(), "%Y")
dane$buildingAge <- ifelse(is.na(dane$buildYear), NA, as.numeric(currentYear) - dane$buildYear)

# Tworzenie kategorii wieku mieszkań
dane$buildingCategory <- cut(
  dane$buildingAge,
  breaks = c(-Inf, 5, 20, 50, Inf),
  labels = c("Nowe", "Średnie", "Stare", "Zabytkowe"),
  right = FALSE
)

# Konwersja na character, dodanie "Nieokreślone", a następnie ponownie na factor
dane$buildingCategory <- as.character(dane$buildingCategory)
dane$buildingCategory[is.na(dane$buildingAge)] <- "Nieokreślone"
dane$buildingCategory <- factor(dane$buildingCategory, levels = c("Nowe", "Średnie", "Stare", "Zabytkowe", "Nieokreślone"))

#table(na.omit(dane$buildingCategory))
#sprawdzić czy nieokreślone ma dalej sens po uzupełnieniu danych

# Sprawdzenie wyników
#table(dane$buildingCategory)
```

### **Obserwacje odstające**

```{r obs_odst_wizualizacja}

dane$buildingAge <- as.numeric(dane$buildingAge)
dane$latitude <- as.numeric(dane$latitude)
dane$longitude <- as.numeric(dane$longitude)
dane$centreDistance <- as.numeric(dane$centreDistance)
dane$schoolDistance <- as.numeric(dane$schoolDistance)
dane$clinicDistance <- as.numeric(dane$clinicDistance)
dane$postOfficeDistance <- as.numeric(dane$postOfficeDistance)
dane$kindergartenDistance <- as.numeric(dane$kindergartenDistance)
dane$collegeDistance <- as.numeric(dane$collegeDistance)
dane$restaurantDistance <- as.numeric(dane$restaurantDistance)
dane$pharmacyDistance <- as.numeric(dane$pharmacyDistance)
dane$floorCount <- as.numeric(dane$floorCount)

ploti1 <- boxplot(dane$squareMeters, main = "Outliers in Square Meters", col = "skyblue")
ploti2 <- boxplot(dane$price, main = "Outliers in Price", col = "plum")
ploti3 <- boxplot(dane$pricePerSquareMeter, main = "Outliers in pricePerSquareMeter", col = "peachpuff")
ploti4 <- boxplot(dane$rooms, main = "Outliers in Rooms", col = "palegreen2")
ploti5 <- boxplot(dane$floor, main = "Outliers in Floors", col = "powderblue")
ploti6 <- boxplot(dane$floorCount, main = "Outliers in FloorCount", col = "thistle3")
ploti7 <- boxplot(dane$buildingAge, main = "Outliers in BuildingAge", col = "salmon")
ploti10 <- boxplot(dane$centreDistance, main = "Outliers in CentreDistance", col = "pink4")
ploti11 <- boxplot(dane$schoolDistance, main = "Outliers in SchoolDistance", col = "pink")
ploti12 <- boxplot(dane$clinicDistance, main = "Outliers in ClinicDistance", col = "orange")
ploti13 <- boxplot(dane$postOfficeDistance, main = "Outliers in PostOfficeDistance", col = "coral")
ploti14 <- boxplot(dane$kindergartenDistance, main = "Outliers in KindergardenDistance", col = "lavender")
ploti15 <- boxplot(dane$restaurantDistance, main = "Outliers in RestaurantDistance", col = "khaki")
ploti16 <- boxplot(dane$collegeDistance, main = "Outliers in CollegeDistance", col = "indianred")
ploti17 <- boxplot(dane$pharmacyDistance, main = "Outliers in PharmacyDistance", col = "lavenderblush2")

# Test Grubbsa dla każdej zmiennej

library(outliers)

variables <- c("squareMeters", "price", "pricePerSquareMeter", "rooms", "floor", 
               "floorCount", "buildingAge", "latitude", "longitude", "centreDistance", 
               "schoolDistance", "clinicDistance", "postOfficeDistance", 
               "kindergartenDistance", "restaurantDistance", "collegeDistance", 
               "pharmacyDistance")


for (var in variables) {

  test_result <- grubbs.test(dane[[var]])
  print(test_result)
}


# Mediana i średnia dla price
median_price <- median(dane$price)
mean_price <- mean(dane$price)

# Mediana i średnia dla SquareMeters
median_squareMeters <- median(dane$squareMeters)
mean_squareMeters <- mean(dane$squareMeters)

# Mediana i średnia dla pricePerSquareMeter
median_pricePerSquareMeter <- median(dane$pricePerSquareMeter)
mean_pricePerSquareMeter <- mean(dane$pricePerSquareMeter)

# Mediana i średnia dla BuildingAge
median_buildingAge <- median(dane$buildingAge)
mean_buildingAge <- mean(dane$buildingAge)

# Mediana i średnia dla Latitude
median_latitude <- median(dane$latitude)
mean_latitude <- mean(dane$latitude)

# Mediana i średnia dla Longitude
median_longitude <- median(dane$longitude)
mean_longitude <- mean(dane$longitude)

```

Do analizy obserwacji odstających posłużono się testem Grubbsa. W teście stwierdzono, że:

1)  ***dla squareMaters wartość 150 jest potencjalnie odstającym wynikiem. Jednakże z p-value wynoszącym 0.06864, co jest większe niż 0.05, uznano, że nie ma wystarczających dowodów, aby tę hipotezę odrzucić. Mediana dla squareMeters wynosi 52.81, a średnia 56.97. Obie te wartości są bliskie sobie, co wskazuje, że dane są rozłożone stosunkowo równomiernie, a różnice między nimi nie są duże. To sugeruje, że wartość 150 nie jest skrajnie różna od pozostałych danych. Wartość ta, choć wyraźnie wyższa, mieści się w szerszym kontekście rozkładu, gdyż mediana i średnia wskazują na brak silnych odchyleń w danych.***

2)  **dla price wartość 3 000 000 jest wartością odstającą. Zgodnie z wynikiem testu Grubbsa, statystyka G wynosi 5.04755, p-value (0.004775) jest poniżej progu 0.05, co oznacza, że wynik jest statystycznie istotny. Należy ją traktować jako rzadki, ale możliwy przypadek bardzo drogiej nieruchomości. Boxplot pokazuje, że ta wartość nie jest błędem, lecz wynikiem specyficznej sytuacji na rynku.**

3)  **dla pricePerSquareMeter Test Grubbsa dał wyniki, że najwyższa wartość 30 702.75 jest potencjalną wartością odstającą. Wynik p-value = (1) sugeruje, że nie powinniśmy odrzucać hipotezy zerowej, przez co nie uznano tej wartości za wartość odstającą i mieści się ona w ogólnym rozkładzie.**

    **#Sprawdzić p=1 (rzadko spotykane)**

    **#mamy wartosci odstajace/review/change**

4)  dla rooms Test Grubbsa **wykazał**, że wartość 6 jest wartością odstającą (p-value = 1). Choć wartość ta jest najwyższa w zbiorze, brak dowodów na jej odstępstwo od reszty danych oznacza, że mieści się w ogólnym rozkładzie. Jednostka mieszkalna posiadająca 6 pomieszczeń zdarza się w rzeczywistości i nie jest błędem, a rzadkim i możliwym przypadkiem, który mieści się w ogólnym rozkładzie.

5)  dla floor odstająca obserwacja wynosi 29. Wynik p-value mniejszy niż 2.2e-16 sugeruje, że ta wartość jest statystycznie istotnie różna od reszty danych, co wskazuje, że jest to wyjątkowy przypadek. Mimo to, nie może zostać pominięta w badaniach zbioru, gdyż nie wynika z błędu, a z rzadkiej sytuacji, gdy nieruchomość znajduje się w wieżowcu na 29 pietrze. Dla floorCount zastosowano podobną zasadę.

6)  dla buildingAge obserwacja odstająca wynosi 174. Nie jest to wynikiem błędu; w danych sprzedaży znalazły się również nieruchomości zabytkowe, mające ponad 50 lat. Mimo tego, że wartość ta jest znacząco wyższa od mediany i średniej, powinna zostać w badanym zbiorze. Tak znaczące ekstremum może wskazywać na wyjątkową pod względem wieku nieruchomość, np. dworek, zamek, kamienicę.

7)  dla Latitude obserwacją odstającą jest 54.58287; jednakże nie odbiega istotnie od przeciętnych wartości w zbiorze.

8)  dla Longitude obserwacja odstająca jest 14.4471272; nie odbiega jednak ona znacząco od średniej i mediany w tym zbiorze.

9)  w CentreDistance, SchoolDistance, ClinicDistance, PostOfficeDistance, KindergardenDsitance, RestaurantDistance, CollegeDistance oraz PharamcyDistance zaobserwowane odstające co prawda są oddalone od reszty danych, jednak ich odległość nie jest wystarczająco duża, by znacząco wpłynęły na ogólną charakterystykę danych zbiorów. Z tego względu zostały one uwzględnione w dalszej analizie, ponieważ mogą reprezentować istotne, choć rzadkie przypadki w danych.

Pomimo zauważenia kilku obserwacji odstających w naszym zbiorze danych, żadna z nich nie została wykluczona z dalszej analizy. Żadna z obserwacji nie odbiega znacząco od średnich w danych rozkładach i mieszczą się w ich schemacie.

W kontekście rynku nieruchomości takie wartości mogą być naturalne, choć rzadkie, i stanowić istotną część analizowanych danych. Nie są one błędami pomiarów, a wzięte pod uwagę znacznie uatrakcyjnią i oddadzą rzeczywisty obraz naszych badań.

```{r dodanie_nowych_danych}
# Wczytanie granic admistracyjnych województw

# Wczytanie danych przestrzennych
wojewodztwa <- st_read(gml_file)

# Tworzenie punktów z danych (longitude i latitude)
punkty <- st_as_sf(dane, coords = c("longitude", "latitude"), crs = 4326)

# Dopasowanie układu współrzędnych punktów do układu pliku GML
punkty <- st_transform(punkty, st_crs(wojewodztwa))

# Dopasowanie punktów do granic województw
dane_with_region <- st_join(punkty, wojewodztwa)

# Dodanie kolumny 'wojewodztwo' na podstawie JPT_NAZWA_
dane$wojewodztwo <- dane_with_region$JPT_NAZWA_

# Sprawdzenie wyników
#head(dane$wojewodztwo)

# Obliczenie średniej ceny za metr kwadratowy na województwo
srednie_ceny_m2 <- dane %>%
  group_by(wojewodztwo) %>%
  summarise(srednia_cena_m2 = mean(pricePerSquareMeter, na.rm = TRUE))

# Połączenie danych o cenach z granicami województw
wojewodztwa <- wojewodztwa %>%
  left_join(srednie_ceny_m2, by = c("JPT_NAZWA_" = "wojewodztwo"))

# Obliczenie centroidów województw dla etykiet
wojewodztwa_centroidy <- wojewodztwa %>%
  st_centroid() %>%
  mutate(label = JPT_NAZWA_)
```

```{r wykres_choropleth}
# Tworzenie mapy choropleth
ggplot(data = wojewodztwa) +
  geom_sf(aes(fill = srednia_cena_m2), color = "black", size = 0.2) +
  scale_fill_gradient(name = "Śr. cena za m² (PLN)", 
                      low = "white", high = "red", na.value = "gray",
                      labels = label_number(big.mark = " ", decimal.mark = ",")) +
  geom_sf_text(data = wojewodztwa_centroidy, aes(label = label), size = 3, color = "black") +
  theme_minimal() +
  labs(title = "Średnia cena za m² w Polsce według województw",
       caption = "Źródło: https://www.geoportal.gov.pl/") +
  theme(legend.position = "right")
```
