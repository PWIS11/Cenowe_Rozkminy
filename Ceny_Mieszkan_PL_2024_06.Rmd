---
title: "Analiza cen mieszkań w Polsce"
date: "`r Sys.Date()`"
author: "Piotr Wiśniewski - lider zespołu, Izabela Reszka, Klaudia Woźniak"
output:
  html_document:
    theme: cerulean
    highlight: tango
    highlight_color: "goldenrod"
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```

```{r setup, include=FALSE}
# Instalacja wymaganych pakietów

if (!requireNamespace("httr", quietly = TRUE)) install.packages("httr")
if (!requireNamespace("jsonlite", quietly = TRUE)) install.packages("jsonlite")
if (!requireNamespace("tidygeocoder", quietly = TRUE)) install.packages("tidygeocoder")
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
if (!requireNamespace("sf", quietly = TRUE)) install.packages("sf")
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
if (!requireNamespace("scales", quietly = TRUE)) install.packages("scales")

```

```{r libraries}

library(httr)
library(jsonlite)
library(tidygeocoder)
library(dplyr)
library(sf)
library(ggplot2)
library(scales)

```


# **Cel projektu**

Celem naszego projektu jest analiza cen mieszkań w największych miastach Polski, uwzględniając różnorodne czynniki, które mogą wpływać na wartość nieruchomości. Wykorzystamy metody analizy danych, aby odpowiedzieć na kluczowe pytania, takie jak:

-   *Od czego zależy cena mieszkań?*

-   *Jakie różnice w cenach występują pomiędzy miastami?*

-   *Czy odległość od centrum lub interesujących miejsc (POI) ma znaczenie dla wartości nieruchomości?*

-   *Które cechy mieszkań (np. liczba pokoi, stan, udogodnienia) są najbardziej cenione?*

### **Analizy w projekcie**

Planujemy zastosowanie narzędzi analizy danych oraz wizualizacji, aby lepiej zrozumieć rynek nieruchomości w Polsce. Nasze analizy obejmą:

-   Badanie zależności między cechami mieszkań (takimi jak lokalizacja, powierzchnia, liczba pokoi) a ich ceną.

-   Porównanie cen nieruchomości pomiędzy największymi polskimi miastami, w celu wykazania kluczowych różnic regionalnych.

-   Modelowanie predykcyjne, które pozwoli oszacować cenę mieszkań na podstawie wybranych zmiennych, takich jak odległość od centrum czy stan mieszkania.

-   Wykorzystanie interaktywnych wizualizacji, takich jak mapy i wykresy, aby przedstawić wyniki w przystępny sposób.

### **Hipotezy i oczekiwane wyniki**

1.  **Odległość od centrum miasta:** Zakładamy, że im bliżej centrum, tym wyższa cena mieszkań, choć siła tego wpływu może różnić się w zależności od miasta.

2.  **Cechy nieruchomości:** Udogodnienia takie jak balkon, winda czy miejsce parkingowe znacząco podnoszą wartość mieszkań, zwłaszcza w dużych miastach.

3.  **Różnice regionalne:** Miasta o wyższym poziomie urbanizacji i rozwiniętej infrastrukturze (np. Warszawa, Kraków, Wrocław) mają wyższe ceny mieszkań w porównaniu do mniejszych miejscowości.

4.  **Rok budowy:** Starsze mieszkania, wymagające remontu, są z reguły tańsze, chyba że znajdują się w prestiżowych lokalizacjach.

Podsumowując, oczekujemy, że nasze analizy wskażą najważniejsze czynniki wpływające na ceny mieszkań oraz umożliwią stworzenie użytecznych modeli predykcyjnych, które mogą wspierać decyzje zakupowe lub inwestycyjne.

# **Opis danych**

Zbiór danych pochodzi z ofert sprzedaży i wynajmu mieszkań z 15 największych polskich miast, zgromadzonych w czerwcu 2024 roku. Dane te obejmują szerokie spektrum cech nieruchomości oraz dodatkowe informacje z Open Street Map, które pozwalają uwzględnić kontekst sąsiedztwa mieszkań.

**Miasta w zbiorze danych:** Warszawa, Łódź, Kraków, Wrocław, Poznań, Gdańsk, Szczecin, Bydgoszcz, Lublin, Katowice, Białystok, Częstochowa.

**Główne pola w zbiorze danych:**

-   ***Lokalizacja i charakterystyka nieruchomości:***

    -   Miasto, typ budynku, wielkość w metrach kwadratowych, liczba pokoi, piętro, rok budowy.

-   ***Informacje kontekstowe:***

    -   Odległość od centrum miasta, liczba interesujących punktów w promieniu 500 metrów (np. szkoły, apteki, restauracje) oraz odległość do najbliższego punktu.

-   ***Cechy nieruchomości:***

    -   Stan mieszkania, rodzaj własności, obecność udogodnień (np. winda, balkon, miejsce parkingowe, ochrona).

-   ***Cena ofertowa:***

    -   Cena sprzedaży lub miesięczny czynsz.

### **Znaczenie projektu**

Rynek nieruchomości jest dynamiczny i podlega wpływowi wielu czynników, takich jak lokalizacja, liczba pokoi, dostępność udogodnień czy bliskość kluczowych miejsc. Analiza tych danych pozwoli lepiej zrozumieć mechanizmy kształtowania się cen mieszkań oraz stworzyć narzędzia wspomagające decyzje zakupowe i inwestycyjne.

```{r}
# Przygotowanie i wczytanie danych 
dane <- read.csv("apartments_pl_2024_06.csv", sep = ",", header = TRUE)

# Zmiana id na liczby rosnące, zaczynające się od cyfry 1
dane$id <- 1:nrow(dane)

# Dane brakujące
# Sprawdzenie ile mamy wartości NA w naszym zbiorze "dane"
# Liczba braków danych (NA + "")
sum(is.na(dane))

# Zbadanie ilości pustych wierszy, np. kolumna condition, buildingMaterial...
sum(dane == "", na.rm = TRUE)

# Zamiana pustych ciągów na NA
dane[dane == ""] <- NA

#Sprawdzenie ile finalnie jest NA w zbiorze "dane"
sum(is.na(dane))
str(dane)

# Analiza % brakujących danych 
colSums(is.na(dane)) / nrow(dane) * 100

# Obliczanie % brakujących danych w każdej kolumnie i ich zestawienie
missing_data <- colSums(is.na(dane)) / nrow(dane) * 100

missing_df <- data.frame(
column = names(missing_data),
missing_percent = missing_data
)

# Najwyższy % brakujących danych;
# Największe braki w: kondycji, materiale budowniczym, typie, podłodze, wieku nieruchomości, posiadaniu windy, odległości do uczelni; 
# reszta braków <1%
missing_df <- missing_df %>%
arrange(desc(missing_percent))

# Sprawdzenie jakie mamy miasta w danych i w których mamy najwięcej NA
unique(dane$city)
miasta_na <- dane %>%
group_by(city) %>%
summarize(liczba_na = sum(is.na(city), na.rm = TRUE)) %>%
arrange(desc(liczba_na))
miasta_na <- table(is.na(dane$city), dane$city)

# Pozbycie się kolumny "condition", gdzie procent "NA" wynosi ok. 74%
dane$condition <- NA 
dane <- subset(dane, select = -condition)




# Dane odstające


# Dodanie kolumny z ceną za metr kwadratowy
dane$pricePerSquareMeter <- dane$price / dane$squareMeters

# Dodanie kolumny z wiekiem mieszkania
currentYear <- format(Sys.Date(), "%Y")
dane$buildingAge <- ifelse(is.na(dane$buildYear), NA, as.numeric(currentYear) - dane$buildYear)

# Tworzenie kategorii wieku mieszkań
dane$buildingCategory <- cut(
  dane$buildingAge,
  breaks = c(-Inf, 5, 20, 50, Inf),
  labels = c("Nowe", "Średnie", "Stare", "Zabytkowe"),
  right = FALSE
)

# Konwersja na character, dodanie "Nieokreślone", a następnie ponownie na factor
dane$buildingCategory <- as.character(dane$buildingCategory)
dane$buildingCategory[is.na(dane$buildingAge)] <- "Nieokreślone"
dane$buildingCategory <- factor(dane$buildingCategory, levels = c("Nowe", "Średnie", "Stare", "Zabytkowe", "Nieokreślone"))

# Sprawdzenie wyników
table(dane$buildingCategory)


# Wczytanie granic admistracyjnych województw
gml_file <- "ms_A01_Granice_wojewodztw.gml"

# Wczytanie danych przestrzennych
wojewodztwa <- st_read(gml_file)

# Tworzenie punktów z danych (longitude i latitude)
punkty <- st_as_sf(dane, coords = c("longitude", "latitude"), crs = 4326)

# Dopasowanie układu współrzędnych punktów do układu pliku GML
punkty <- st_transform(punkty, st_crs(wojewodztwa))

# Dopasowanie punktów do granic województw
dane_with_region <- st_join(punkty, wojewodztwa)

# Dodanie kolumny 'wojewodztwo' na podstawie JPT_NAZWA_
dane$wojewodztwo <- dane_with_region$JPT_NAZWA_

# Sprawdzenie wyników
head(dane$wojewodztwo)

# Obliczenie średniej ceny za metr kwadratowy na województwo
srednie_ceny_m2 <- dane %>%
  group_by(wojewodztwo) %>%
  summarise(srednia_cena_m2 = mean(pricePerSquareMeter, na.rm = TRUE))

# Połączenie danych o cenach z granicami województw
wojewodztwa <- wojewodztwa %>%
  left_join(srednie_ceny_m2, by = c("JPT_NAZWA_" = "wojewodztwo"))

# Obliczenie centroidów województw dla etykiet
wojewodztwa_centroidy <- wojewodztwa %>%
  st_centroid() %>%
  mutate(label = JPT_NAZWA_)


# Tworzenie mapy choropleth

ggplot(data = wojewodztwa) +
  geom_sf(aes(fill = srednia_cena_m2), color = "black", size = 0.2) +
  scale_fill_gradient(name = "Śr. cena za m² (PLN)", 
                      low = "white", high = "red", na.value = "gray",
                      labels = label_number(big.mark = " ", decimal.mark = ",")) +
  geom_sf_text(data = wojewodztwa_centroidy, aes(label = label), size = 3, color = "black") +
  theme_minimal() +
  labs(title = "Średnia cena za m² w Polsce według województw",
       caption = "Źródło: Twoje dane") +
  theme(legend.position = "right")
```

```{r}
install.packages(c("tidyverse", "naniar", "VIM", "outliers", "caret", "mice"))
```

```{r}
library(tidyverse)
library(naniar)
library(VIM)
library(outliers)
library(caret)
```

```{r}
dane[dane == ""] <- NA
miss_var_summary(dane)
vis_miss(dane)
gg_miss_upset(dane)
sum(is.na(dane$floor))
sum(is.na(dane$condition))
sum(is.na(dane$type))
```

